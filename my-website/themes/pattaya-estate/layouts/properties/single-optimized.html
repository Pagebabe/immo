{{ define "main" }}
<article class="property-detail-optimized">
  <div class="container">
    <!-- Hero Section -->
    <div class="property-hero">
      <div class="property-gallery">
        {{ with .Params.gallery }}
          {{ range first 1 . }}
            {{ $img := resources.Get . }}
            {{ if $img }}
              {{ $resized := $img | images.Fit "1400x900" }}
              {{ $webp := $resized | images.Format "webp" }}
              <picture>
                <source srcset="{{ $webp.RelPermalink }}" type="image/webp">
                <img src="{{ $resized.RelPermalink }}" alt="{{ $.Title }}" class="hero-image">
              </picture>
            {{ end }}
          {{ end }}
        {{ end }}
      </div>
      
      <div class="property-info-sidebar">
        <div class="property-header">
          <h1>{{ .Title }}</h1>
          <div class="property-price-large">
            <span class="price" data-thb="{{ .Params.price | default 0 }}">{{ lang.FormatNumber 0 .Params.price }} {{ .Site.Params.currency }}</span>
          </div>
          <p class="property-location">{{ .Params.location }} â€¢ {{ i18n .Params.type_key | default .Params.type }}</p>
        </div>

        <!-- Key Facts Box -->
        <div class="key-facts-box">
          <h3>ğŸ  Key Facts</h3>
          <div class="facts-grid">
            <div class="fact-item">
              <span class="fact-icon">ğŸ›ï¸</span>
              <span class="fact-label">Schlafzimmer</span>
              <span class="fact-value">{{ .Params.bedrooms | default "N/A" }}</span>
            </div>
            <div class="fact-item">
              <span class="fact-icon">ğŸš¿</span>
              <span class="fact-label">Badezimmer</span>
              <span class="fact-value">{{ .Params.bathrooms | default "N/A" }}</span>
            </div>
            <div class="fact-item">
              <span class="fact-icon">ğŸ“</span>
              <span class="fact-label">WohnflÃ¤che</span>
              <span class="fact-value">{{ .Params.living_area | default "N/A" }} mÂ²</span>
            </div>
            <div class="fact-item">
              <span class="fact-icon">ğŸŠ</span>
              <span class="fact-label">Pool</span>
              <span class="fact-value">{{ .Params.pool | default "N/A" }}</span>
            </div>
            <div class="fact-item">
              <span class="fact-icon">ğŸ </span>
              <span class="fact-label">Eigentum</span>
              <span class="fact-value">{{ .Params.ownership | default "N/A" }}</span>
            </div>
            <div class="fact-item">
              <span class="fact-icon">ğŸ“„</span>
              <span class="fact-label">Grundbuch</span>
              <span class="fact-value">{{ .Params.deed | default "N/A" }}</span>
            </div>
          </div>
        </div>

        <!-- CTA Section -->
        <div class="property-ctas-optimized">
          <a href="https://wa.me/66XXXXXXXXX?text={{ urlquery (printf "Interesse: %s â€“ %s" .Title .Permalink) }}" 
             class="cta-button whatsapp" target="_blank">
            <span class="cta-icon">ğŸ’¬</span>
            <span class="cta-text">WhatsApp Chat</span>
          </a>
          
          <a href="https://cal.com/your-cal-alias?date=next-7-days&name={{ urlquery .Title }}" 
             class="cta-button primary" target="_blank">
            <span class="cta-icon">ğŸ“…</span>
            <span class="cta-text">Besichtigung buchen</span>
          </a>
          
          <button class="cta-button success" id="open-lead-modal">
            <span class="cta-icon">ğŸ“§</span>
            <span class="cta-text">Kostenlose Beratung</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Gallery Section -->
    {{ with .Params.gallery }}
    <div class="property-gallery-full">
      <h2>ğŸ“¸ Bildergalerie</h2>
      <div class="gallery-grid">
        {{ range . }}
          {{ $img := resources.Get . }}
          {{ if $img }}
            {{ $resized := $img | images.Fit "400x300" }}
            {{ $webp := $resized | images.Format "webp" }}
            <div class="gallery-item">
              <picture>
                <source srcset="{{ $webp.RelPermalink }}" type="image/webp">
                <img src="{{ $resized.RelPermalink }}" alt="{{ $.Title }}" loading="lazy">
              </picture>
            </div>
          {{ end }}
        {{ end }}
      </div>
    </div>
    {{ end }}

    <!-- Content Section -->
    <div class="property-content-optimized">
      <div class="content-main">
        <div class="property-description">
          <h2>ğŸ“ Beschreibung</h2>
          {{ .Content }}
        </div>

        <!-- Map Section -->
        {{ if and .Params.lat .Params.lng }}
        <div class="property-map">
          <h2>ğŸ“ Lage</h2>
          <div id="property-map" style="height: 400px; width: 100%;"></div>
          <script>
            document.addEventListener('DOMContentLoaded', function() {
              const map = L.map('property-map').setView([{{ .Params.lat }}, {{ .Params.lng }}], 15);
              L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
              }).addTo(map);
              L.marker([{{ .Params.lat }}, {{ .Params.lng }}]).addTo(map)
                .bindPopup('{{ .Title }}').openPopup();
            });
          </script>
        </div>
        {{ end }}
      </div>

      <div class="content-sidebar">
        <!-- Contact Form -->
        <div class="contact-form-sidebar">
          <h3>ğŸ’¬ Interesse an dieser Immobilie?</h3>
          <form class="quick-contact-form" action="https://DEIN-N8N/webhook/lead-intake" method="post">
            <div class="form-group">
              <input type="text" name="name" placeholder="Ihr Name *" required>
            </div>
            <div class="form-group">
              <input type="email" name="email" placeholder="E-Mail Adresse *" required>
            </div>
            <div class="form-group">
              <input type="tel" name="phone" placeholder="Telefon/WhatsApp *" required>
            </div>
            <div class="form-group">
              <textarea name="message" placeholder="Ihre Nachricht..." rows="3"></textarea>
            </div>
            <input type="hidden" name="property" value="{{ .Title }}">
            <input type="hidden" name="property_url" value="{{ .Permalink }}">
            <button type="submit" class="btn btn-primary btn-full">
              ğŸ“§ Anfrage senden
            </button>
          </form>
        </div>

        <!-- Social Sharing -->
        <div class="social-sharing-sidebar">
          {{ partial "social-sharing.html" . }}
        </div>
      </div>
    </div>

    <!-- Lead Form Modal -->
    <div id="lead-form-modal" class="modal" style="display: none;">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Kostenlose Immobilienberatung</h3>
          <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
          {{ partial "lead-form.html" . }}
        </div>
      </div>
    </div>
  </div>
</article>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const openLeadModalBtn = document.getElementById('open-lead-modal');
  const leadFormModal = document.getElementById('lead-form-modal');
  const modalCloseBtn = leadFormModal.querySelector('.modal-close');

  if (openLeadModalBtn && leadFormModal && modalCloseBtn) {
    openLeadModalBtn.addEventListener('click', function() {
      leadFormModal.style.display = 'flex';
      if (typeof gtag !== 'undefined') {
        gtag('event', 'modal_open', {
          event_category: 'engagement',
          event_label: 'lead_form_modal',
          page_location: window.location.href
        });
      }
    });

    modalCloseBtn.addEventListener('click', function() {
      leadFormModal.style.display = 'none';
    });

    window.addEventListener('click', function(event) {
      if (event.target == leadFormModal) {
        leadFormModal.style.display = 'none';
      }
    });

    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        leadFormModal.style.display = 'none';
      }
    });
  }
});
</script>
{{ end }}
